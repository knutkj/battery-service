# Using Kaitai Struct for Z-Wave Binary Format Documentation and Parsing

Kaitai Struct is a powerful open-source project that enables declarative,
human-readable descriptions of binary data formats. In this context, it is being
used specifically to document, analyze, and generate tooling for Z-Wave protocol
internals‚Äîsuch as the MPDU (MAC Protocol Data Unit) and related binary
structures. This approach supports reverse engineering, validation, and
collaboration within the Z-Wave domain.

## üü¢ Typical Use Cases for Kaitai Struct in Z-Wave Work

- **Authoritative format specs:** Z-Wave binary structures (like protocol
  headers, diagnostic files, and custom frames) are described in `.ksy` YAML
  files. These serve as the single source of truth for field layouts, types, and
  protocol details.
- **Automated documentation:** Markdown (`.md`) and JSON (`.json`) files are
  generated from `.ksy` specs using scripts or tools. This ensures that
  human-friendly docs and machine-readable definitions are always up to date and
  consistent for Z-Wave formats.
- **Tooling foundation:** The `.ksy` files can be compiled to JavaScript (or
  other languages) using the Kaitai compiler, enabling programmatic parsing and
  validation of real-world Z-Wave binary data, such as MPDU captures.
- **Collaboration and reproducibility:** By using a declarative language,
  contributors can easily review, extend, and verify Z-Wave binary format
  definitions, reducing ambiguity and errors.
- **Interactive exploration:** The [Kaitai Web IDE](https://ide.kaitai.io)
  allows you to experiment with `.ksy` files and binary samples directly in your
  browser. This is especially useful for visualizing Z-Wave structures, testing
  changes, and sharing format definitions with others.

For more details on practical workflows, see the Z-Wave data format guides or
documentation in this workspace.

## üõ†Ô∏è What Kaitai Struct Provides (and What It Doesn't)

Kaitai Struct consists of:

1. **The Compiler (`ksc`)**: Reads `.ksy` files and generates parser code
   (JavaScript, Python, etc).
2. **The Runtime (`kaitai-struct.js`)**: Provides parsing primitives for the
   generated code.

**Important:** The runtime cannot interpret `.ksy` files directly. Parsers must
be generated ahead of time using the compiler. There is no official way to load
and execute `.ksy` specs dynamically in the browser or Node.js at runtime.

## üö¶ Practical Workflow for Z-Wave Formats

- **Write or update a `.ksy` file** to describe a Z-Wave binary format, such as
  the MPDU.
- **Run a script or tool** to generate Markdown and JSON documentation, if
  desired.
- **Use the generated docs** for reference, validation, and as a foundation for
  further Z-Wave tooling.
- **(Optional) Compile `.ksy` to JS** using the Kaitai compiler for programmatic
  parsing in Node.js or browser (with bundling).
- **Experiment in the Kaitai Web IDE** to quickly visualize and test your `.ksy`
  files with real Z-Wave binary data.

This approach ensures that all Z-Wave binary format knowledge is centralized,
versioned, and accessible to both humans and tools.

## ‚ú® Why This Approach Works for Z-Wave

- **Accuracy:** Specs are reviewed and versioned in source control.
- **Reproducibility:** Anyone can regenerate docs or parsers from the same
  `.ksy` files.
- **Extensibility:** New Z-Wave formats or fields can be added with minimal
  friction.
- **Community:** Contributors can focus on the declarative spec, not on
  hand-written parsing code.
- **Immediate feedback:** The Kaitai IDE makes it easy to iterate on format
  definitions and see results instantly.

## ‚ö†Ô∏è About Dynamic Parsing: For Those with the Same Intuition

If you, like me, initially assumed that Kaitai Struct could be used to
dynamically load a `.ksy` file and parse Z-Wave binary data at runtime (in the
browser or Node.js), it's important to clarify this limitation:

- **Kaitai's runtime does not interpret `.ksy` files directly.** It only runs
  code generated by the compiler.
- **Dynamic, user-driven parsing (e.g., uploading a `.ksy` and a hex string in a
  web app) is not natively supported.**

### If You Want Dynamic Parsing

If your intuition is to let users provide their own `.ksy` files and parse
Z-Wave data on the fly, here are your main options:

1. **Precompile and dynamically load:** Use the Kaitai compiler (possibly via a
   server or CLI) to generate parser code from `.ksy` files, then load and
   execute that code dynamically. This works, but requires a compilation step
   and is not purely in-browser.
2. **Custom interpreter:** Build a JavaScript interpreter for a subset of the
   Kaitai language. This is a significant effort, but possible for simple,
   fixed-structure formats.

This distinction is important for anyone approaching Kaitai Struct with the same
expectations. Understanding this up front can save time and help you choose the
right approach for your Z-Wave use case.

## üìå Summary

Kaitai Struct is being used here as a declarative, canonical language for
describing Z-Wave binary formats like the MPDU. This enables accurate
documentation, automated tooling, and collaborative reverse engineering. The
Kaitai Web IDE is an invaluable tool for experimenting with and visualizing
these formats. While dynamic runtime parsing of `.ksy` is not possible out of
the box, understanding the available options can help you make informed
decisions and avoid common pitfalls.

If you want to contribute or learn more, start with the `.ksy` files and see the
Z-Wave data format guides or contribution documentation in this workspace.
